name: Build Development Helm Chart

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git reference to build from (branch, tag, or commit)'
        required: false
        default: ''
      chart_version_suffix:
        description: 'Chart version suffix'
        required: false
        default: '-dev'
      dry_run:
        description: 'Dry run - validate only, do not push'
        required: false
        type: boolean
        default: false
      skip_image_build:
        description: 'Skip Docker image build (use existing image)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - 'claude/**'
      - 'feature/**'
      - 'fix/**'
    paths:
      - 'helm/**'

env:
  REGISTRY: ghcr.io
  CHART_NAME: agentapi-ui
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-image:
    if: ${{ !inputs.skip_image_build }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.image_tag.outputs.tag }}

    steps:
      - name: Determine git ref
        id: git_ref
        run: |
          if [ -n "${{ inputs.git_ref }}" ]; then
            echo "ref=${{ inputs.git_ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.git_ref.outputs.ref }}

      - name: Get commit hash
        id: commit
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "full_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Generate image tag
        id: image_tag
        run: |
          BRANCH_NAME="${{ steps.git_ref.outputs.ref }}"
          BRANCH_NAME="${BRANCH_NAME#refs/heads/}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | cut -c1-50)
          TAG="${{ steps.commit.outputs.sha }}-${SAFE_BRANCH}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated image tag: ${TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.image_tag.outputs.tag }}
            type=raw,value=${{ steps.commit.outputs.sha }}-dev
            type=raw,value=latest-dev

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ !inputs.dry_run }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  build-helm:
    needs: [build-image]
    if: always() && (needs.build-image.result == 'success' || needs.build-image.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Determine git ref
        id: git_ref
        run: |
          if [ -n "${{ inputs.git_ref }}" ]; then
            echo "ref=${{ inputs.git_ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.git_ref.outputs.ref }}

      - name: Get commit hash
        id: commit
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.14.0'

      - name: Generate versions
        id: versions
        run: |
          # Get base version from Chart.yaml
          BASE_VERSION=$(grep '^version:' helm/agentapi-ui/Chart.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
          # Remove 'v' prefix if present
          BASE_VERSION="${BASE_VERSION#v}"

          SUFFIX="${{ inputs.chart_version_suffix || '-dev' }}"
          CHART_VERSION="${BASE_VERSION}${SUFFIX}.${{ steps.commit.outputs.sha }}"

          # Generate image tag
          BRANCH_NAME="${{ steps.git_ref.outputs.ref }}"
          BRANCH_NAME="${BRANCH_NAME#refs/heads/}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | cut -c1-50)

          if [ "${{ needs.build-image.outputs.image_tag }}" != "" ]; then
            IMAGE_TAG="${{ needs.build-image.outputs.image_tag }}"
          else
            IMAGE_TAG="${{ steps.commit.outputs.sha }}-${SAFE_BRANCH}"
          fi

          echo "chart_version=${CHART_VERSION}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Chart version: ${CHART_VERSION}"
          echo "Image tag: ${IMAGE_TAG}"

      - name: Validate YAML syntax
        run: |
          echo "Validating YAML syntax..."
          for f in helm/agentapi-ui/*.yaml helm/agentapi-ui/templates/*.yaml; do
            if [ -f "$f" ]; then
              echo "Checking $f"
              python3 -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
            fi
          done
          echo "YAML validation passed!"

      - name: Lint Helm chart
        run: |
          echo "Running Helm lint..."
          helm lint helm/agentapi-ui --strict
          echo "Helm lint passed!"

      - name: Template validation
        run: |
          echo "Validating Helm templates..."
          helm template agentapi-ui helm/agentapi-ui \
            --set image.tag=${{ steps.versions.outputs.image_tag }} \
            > /tmp/rendered-templates.yaml
          echo "Template rendering successful!"

      - name: Test with different configurations
        run: |
          echo "Testing default configuration..."
          helm template agentapi-ui helm/agentapi-ui --debug > /dev/null

          echo "Testing with ingress enabled..."
          helm template agentapi-ui helm/agentapi-ui \
            --set ingress.enabled=true \
            --set ingress.className=nginx \
            --debug > /dev/null

          echo "Testing with OAuth only mode..."
          helm template agentapi-ui helm/agentapi-ui \
            --set oauthOnlyMode.enabled=true \
            --set oauthOnlyMode.proxyUrl=http://proxy:8080 \
            --debug > /dev/null

          echo "Testing with HPA enabled..."
          helm template agentapi-ui helm/agentapi-ui \
            --set autoscaling.enabled=true \
            --debug > /dev/null

          echo "All configuration tests passed!"

      - name: Update Chart.yaml with development version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.versions.outputs.chart_version }}/" helm/agentapi-ui/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.versions.outputs.image_tag }}\"/" helm/agentapi-ui/Chart.yaml
          echo "Updated Chart.yaml:"
          cat helm/agentapi-ui/Chart.yaml

      - name: Package Helm chart
        run: |
          mkdir -p ./charts
          helm package helm/agentapi-ui --destination ./charts
          ls -la ./charts/

      - name: Log in to Container Registry
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Helm chart to OCI registry
        if: ${{ !inputs.dry_run }}
        run: |
          helm push ./charts/${{ env.CHART_NAME }}-${{ steps.versions.outputs.chart_version }}.tgz \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts
          echo "Chart pushed successfully!"

      - name: Generate installation instructions
        id: instructions
        run: |
          cat << 'EOF' > install-instructions.md
          # Development Helm Chart Installation

          ## Quick Install

          ```bash
          helm install agentapi-ui \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.versions.outputs.chart_version }}
          ```

          ## With Custom Values

          ```bash
          helm install agentapi-ui \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.versions.outputs.chart_version }} \
            --set image.tag=${{ steps.versions.outputs.image_tag }} \
            --set ingress.enabled=true \
            --set ingress.className=nginx
          ```

          ## Upgrade Existing Installation

          ```bash
          helm upgrade agentapi-ui \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.versions.outputs.chart_version }}
          ```

          ## Chart Details

          - **Chart Version:** ${{ steps.versions.outputs.chart_version }}
          - **Image Tag:** ${{ steps.versions.outputs.image_tag }}
          - **Registry:** ${{ env.REGISTRY }}/${{ github.repository_owner }}/charts
          EOF

          cat install-instructions.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-dev
          path: |
            ./charts/
            install-instructions.md
          retention-days: 7

      - name: Create GitHub Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # Development Helm Chart Build Summary

          ## Build Information

          | Property | Value |
          |----------|-------|
          | Chart Version | \`${{ steps.versions.outputs.chart_version }}\` |
          | Image Tag | \`${{ steps.versions.outputs.image_tag }}\` |
          | Git Ref | \`${{ steps.git_ref.outputs.ref }}\` |
          | Commit | \`${{ steps.commit.outputs.sha }}\` |
          | Dry Run | \`${{ inputs.dry_run || 'false' }}\` |

          ## Installation

          \`\`\`bash
          helm install agentapi-ui \\
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \\
            --version ${{ steps.versions.outputs.chart_version }}
          \`\`\`
          EOF
