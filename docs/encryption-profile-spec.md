# 暗号化プロファイル仕様書

## 概要

本仕様書は、agentapi-ui における暗号化プロファイル機能の技術仕様を定義します。

## プロファイル形式

### 生プロファイル構造

生プロファイルは以下の形式で構成されます：

```
{ハッシュ化したトークン}.{base64エンコードしたプロファイル情報}
```

#### 構成要素

1. **ハッシュ化したトークン**
   - トークンをハッシュ化した値
   - ハッシュアルゴリズム: SHA-256
   - 形式: 16進数文字列

2. **base64エンコードしたプロファイル情報**
   - プロファイル情報をJSON形式でシリアライズ
   - UTF-8エンコーディングでバイト配列に変換
   - base64でエンコード
   - URLセーフな形式（`+` → `-`、`/` → `_`、パディング `=` を削除）

### プロファイル情報の構造

```typescript
interface ProfileInfo {
  // プロファイル固有の情報
  id: string;
  name: string;
  settings: Record<string, any>;
  createdAt: string;
  updatedAt: string;
  // その他の必要な情報
}
```

## 暗号化仕様

### 暗号化アルゴリズム

- **アルゴリズム**: AES-256-GCM
- **鍵長**: 256ビット
- **初期化ベクトル（IV）**: 96ビット（12バイト）
- **認証タグ**: 128ビット（16バイト）

### 暗号化プロセス

1. 生プロファイルを生成
2. AES-256-GCMで暗号化
3. 暗号化データ形式：
   ```
   {IV}{暗号化されたデータ}{認証タグ}
   ```
4. 全体をbase64エンコード

## 検証プロセス

### 復号化と検証の手順

1. **暗号化プロファイルの復号化**
   - base64デコード
   - IV、暗号化データ、認証タグを分離
   - AES-256-GCMで復号化

2. **生プロファイルの解析**
   - `.` で分割してトークンハッシュとプロファイル情報を取得
   - プロファイル情報をbase64デコード
   - JSONとしてパース

3. **トークン検証**
   - リクエストで受け取ったトークンをSHA-256でハッシュ化
   - 生プロファイルから取得したハッシュと比較
   - 一致しない場合は検証失敗

### エラーハンドリング

検証失敗時のケース：
- 復号化失敗（不正な暗号化データ）
- トークンハッシュ不一致
- プロファイル情報のパース失敗
- 認証タグ検証失敗

## API仕様

### エンドポイント

```
POST /api/profiles/encrypt
```

### リクエスト

```json
{
  "token": "string",
  "profile": {
    "id": "string",
    "name": "string",
    "settings": {},
    "createdAt": "string",
    "updatedAt": "string"
  }
}
```

### レスポンス

成功時（200 OK）:
```json
{
  "encryptedProfile": "string"
}
```

エラー時（400 Bad Request）:
```json
{
  "error": "string",
  "code": "string"
}
```

### エンドポイント

```
POST /api/profiles/decrypt
```

### リクエスト

```json
{
  "token": "string",
  "encryptedProfile": "string"
}
```

### レスポンス

成功時（200 OK）:
```json
{
  "profile": {
    "id": "string",
    "name": "string",
    "settings": {},
    "createdAt": "string",
    "updatedAt": "string"
  }
}
```

エラー時（400 Bad Request）:
```json
{
  "error": "string",
  "code": "string"
}
```

## セキュリティ考慮事項

1. **鍵管理**
   - 暗号化鍵は環境変数で管理
   - 定期的な鍵のローテーション

2. **トークン管理**
   - トークンは平文で保存しない
   - トークンの有効期限管理

3. **通信セキュリティ**
   - HTTPS通信の必須化
   - CSRFトークンの使用

4. **監査ログ**
   - 暗号化・復号化操作のログ記録
   - 失敗した検証試行の記録

## 実装上の注意点

1. **パフォーマンス**
   - 暗号化・復号化処理の非同期実行
   - 適切なタイムアウト設定

2. **互換性**
   - base64のURLセーフ形式の使用
   - UTF-8エンコーディングの統一

3. **エラーメッセージ**
   - セキュリティを考慮した汎用的なエラーメッセージ
   - 詳細なエラー情報は内部ログのみ

## 今後の拡張性

1. **暗号化アルゴリズムの変更**
   - バージョン識別子の追加
   - 後方互換性の維持

2. **プロファイル情報の拡張**
   - スキーマバージョニング
   - 必須フィールドと任意フィールドの定義

3. **マルチテナント対応**
   - テナント別の暗号化鍵
   - プロファイルの共有機能